<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapa de Reserva</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <style>
        body {
            background: #f0f2f5;
        }

        #map {
            position: relative;
            width: 100%;
            max-width: 1000px;
            margin: auto;
            aspect-ratio: 16 / 9;
            background-color: #dee2e6;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 10px;
            overflow: hidden;
        }

        .seat {
            position: absolute;
            border-radius: 50%;
            border: 2px solid #fff;
            transform: translate(-50%, -50%);
            cursor: pointer;
            background: rgba(46, 204, 113, 0.45);
            /* verde */
        }

        .seat.occupied {
            background: rgba(231, 76, 60, 0.55);
            /* vermelho */
            cursor: not-allowed;
        }

        .preview {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            border: 1px dashed #fff;
            background: rgba(46, 204, 113, 0.25);
            transform: translate(-50%, -50%);
        }

        .btn-mode.active {
            box-shadow: inset 0 0 0 2px #00000030;
        }
    </style>
</head>

<body class="p-3">
    <div class="container">
        <h4 class="mb-3">Mapa de Reserva</h4>

        <div class="d-flex flex-wrap gap-2 mb-3">
            <input type="file" id="imageInput" class="form-control form-control-sm w-auto" accept="image/*" />

            <button id="editBtn" class="btn btn-sm btn-outline-primary btn-mode active">
                Modo Edição
            </button>

            <button id="reserveBtn" class="btn btn-sm btn-outline-success btn-mode">
                Modo Reserva
            </button>

            <button id="exportLayout" class="btn btn-sm btn-outline-secondary">
                Export Layout
            </button>

            <button id="exportOccupied" class="btn btn-sm btn-outline-secondary">
                Export Reservas
            </button>

            <div class="d-flex align-items-center gap-2">
                <small>Tamanho</small>
                <input type="range" id="sizeRange" min="10" max="40" value="20" />
            </div>
        </div>

        <div id="map"></div>
    </div>

    <!-- Modal de Confirmação -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Reserva</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">Deseja realmente reservar este assento?</div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="button" id="confirmSeatBtn" class="btn btn-primary">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const map = document.getElementById("map");
        const imageInput = document.getElementById("imageInput");
        const sizeRange = document.getElementById("sizeRange");

        const editBtn = document.getElementById("editBtn");
        const reserveBtn = document.getElementById("reserveBtn");

        let mode = "edit";
        let seatSize = 20;
        let seats = [];
        let draggingSeat = null;
        let preview = null;
        let seatToConfirm = null;

        const confirmModal = new bootstrap.Modal(
            document.getElementById("confirmModal")
        );

        // ---------- Imagem ----------
        imageInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = () => {
                const base64 = reader.result;
                localStorage.setItem("roomImage", base64);
                map.style.backgroundImage = `url(${base64})`;
            };

            reader.readAsDataURL(file);
        };

        // ---------- Modos ----------
        function setMode(newMode) {
            mode = newMode;
            document
                .querySelectorAll(".btn-mode")
                .forEach((b) => b.classList.remove("active"));
            if (mode === "edit") editBtn.classList.add("active");
            if (mode === "reserve") reserveBtn.classList.add("active");
        }

        editBtn.onclick = () => setMode("edit");
        reserveBtn.onclick = () => setMode("reserve");

        // ---------- Tamanho ----------
        sizeRange.oninput = (e) => {
            seatSize = +e.target.value;
            render();
            save();
        };

        // ---------- Preview ----------
        map.addEventListener("mousemove", (e) => {
            if (mode !== "edit") return;

            if (!preview) {
                preview = document.createElement("div");
                preview.className = "preview";
                map.appendChild(preview);
            }

            const rect = map.getBoundingClientRect();
            preview.style.left = ((e.clientX - rect.left) / rect.width) * 100 + "%";
            preview.style.top = ((e.clientY - rect.top) / rect.height) * 100 + "%";
            preview.style.width = seatSize + "px";
            preview.style.height = seatSize + "px";
        });

        map.addEventListener("mouseleave", () => {
            preview?.remove();
            preview = null;
        });

        // ---------- Arrastar ----------
        map.onmousedown = (e) => {
            if (mode !== "edit") return;
            if (!e.target.classList.contains("seat")) return;
            draggingSeat = seats.find((s) => s.id == e.target.dataset.id);
        };

        map.onmouseup = () => (draggingSeat = null);

        map.onmousemove = (e) => {
            if (!draggingSeat) return;
            const rect = map.getBoundingClientRect();
            draggingSeat.x = ((e.clientX - rect.left) / rect.width) * 100;
            draggingSeat.y = ((e.clientY - rect.top) / rect.height) * 100;
            render();
            save();
        };

        // ---------- Click ----------
        map.onclick = (e) => {
            if (e.target.classList.contains("seat")) {
                const seat = seats.find((s) => s.id == e.target.dataset.id);

                if (mode === "edit") {
                    seats = seats.filter((s) => s.id !== seat.id);
                }

                if (mode === "reserve" && !seat.occupied) {
                    seatToConfirm = seat;
                    confirmModal.show();
                }

                save();
                render();
                return;
            }

            if (mode !== "edit") return;

            const rect = map.getBoundingClientRect();
            seats.push({
                id: Date.now(),
                x: ((e.clientX - rect.left) / rect.width) * 100,
                y: ((e.clientY - rect.top) / rect.height) * 100,
                size: seatSize,
                occupied: false,
            });

            save();
            render();
        };

        // ---------- Confirmar ----------
        document.getElementById("confirmSeatBtn").onclick = () => {
            if (!seatToConfirm) return

            seatToConfirm.occupied = true
            seatToConfirm.selected = false
            seatToConfirm = null

            save()
            render()
            confirmModal.hide()
        }

        // ---------- Exportar ----------
        exportLayout.onclick = () => {
            const layout = seats.map(({ id, x, y, size }) => ({ id, x, y, size }));
            download(layout, "roomLayout.json");
        };

        exportOccupied.onclick = () => {
            const occupied = seats.filter((s) => s.occupied).map((s) => s.id);
            download(occupied, "occupiedSeats.json");
        };

        function download(data, name) {
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: "application/json",
            });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = name;
            a.click();
        }

        // ---------- Armazenamento local ----------
        function save() {
            localStorage.setItem("roomSeats", JSON.stringify(seats));
        }

        function load() {
            const data = localStorage.getItem("roomSeats");
            if (!data) return;
            seats = JSON.parse(data);
            render();
            initTooltips()
        }

        const savedImage = localStorage.getItem("roomImage");
        if (savedImage) {
            map.style.backgroundImage = `url(${savedImage})`;
        }

        function render() {
            disposeTooltips()

            map.querySelectorAll(".seat").forEach(el => el.remove())

            seats.forEach((seat) => {
                const el = document.createElement("div")
                el.className = "seat"

                if (seat.occupied) {
                    el.classList.add("occupied")
                    el.setAttribute("data-bs-toggle", "tooltip")
                    el.setAttribute("data-bs-title", "Reservado")
                } else {
                    el.setAttribute("data-bs-toggle", "tooltip")
                    el.setAttribute("data-bs-title", "Disponível")
                }

                el.style.left = seat.x + "%"
                el.style.top = seat.y + "%"
                el.style.width = seat.size + "px"
                el.style.height = seat.size + "px"
                el.dataset.id = seat.id

                map.appendChild(el)
            })

            initTooltips()
        }

        load();

        function initTooltips() {
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                new bootstrap.Tooltip(el)
            })
        }

        function disposeTooltips() {
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                const instance = bootstrap.Tooltip.getInstance(el)
                if (instance) instance.dispose()
            })
        }
    </script>
</body>

</html>